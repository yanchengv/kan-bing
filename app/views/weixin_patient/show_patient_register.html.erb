<style>
    /* time scroll*/
    .yanzhengm {
        padding: 5px;
        float: left;
        height: 40px;
        border: 1px solid #ccc;
        width: 60%;
        border-top-left-radius: 5px;
        border-bottom-left-radius: 5px;
    }

    .time {
        font-family: "Microsoft YaHei", Arial, Helvetica, sans-serif;
        display: inline-block;
        border: 0px;
        font-size: 16px;
        text-align: center;
        line-height: 42px;
        padding: 5px;
        float: left;
        color: #333;
        width: 30%;
        height: 52px;
        border-top-right-radius: 5px;
        border-bottom-right-radius: 5px;
        cursor: pointer;
    }

    .gray {
        background: #ccc;
    }

    .green {
        background: #18cbbb
    }
</style>
<div data-role="page" id="pageone">
  <div data-role="content">
    <p class="yahei">手机号注册</p>
    <label for="name" class="ui-hidden-accessible">手机号</label>
    <input type="text" name="mobile_phone" id="mobile_phone" onblur="checkPhoneNum(this)" placeholder="请输入手机号...">

    <div id="infoNote"></div>
    <br>

    <div id="codeInfo"></div>

    <div style="width:90%;margin:15px auto;">

      <input type="text" class="yanzhengm" value="" id="verify_code" data-role="none"/>

      <div class="game_time">
        <input class="time green" id="btnSendCode" type="button" data-role="none" value="发送验证码" onclick="sendMessage()"/>
      </div>


    </div>

  </div>


  <input id="login" type="button" class="ui-btn-up-c" data-inline="true" onclick="login(this)" value="确定">


</div>
</div>



<script>
    //手机号input触发事件
    function checkPhoneNum() {
        var mobile_phone = $("#mobile_phone").val();
        if (mobile_phone == "") {
            $("#infoNote").html("<font color='red'>手机号码不能为空！</font>");
        } else if (!mobile_phone.match(/^1[3|4|5|8][0-9]\d{4,8}$/)) {
            $("#infoNote").html("<font color='red'>手机号码格式不正确！请重新输入！</font>");
        } else {
            $("#infoNote").html("");
        }
    }
    ;


    //提交登陆
    function login() {
        var mobile_phone = $("#mobile_phone").val();
        var verify_code = $("#verify_code").val();
        if (mobile_phone == "") {
            $("#infoNote").html("<font color='red'>手机号码不能为空！</font>");
        } else if (!mobile_phone.match(/^1[3|4|5|8][0-9]\d{4,8}$/)) {
            $("#infoNote").html("<font color='red'>手机号码格式不正确！请重新输入！</font>");
        } else {

            $.ajax({
                url: "/weixin_patient/create_patient_register",
                type: 'post',
                data: {
                    mobile_phone: mobile_phone,
                    verify_code: verify_code,
                    open_id: "<%= @open_id %>"
                },
                success: function (data) {

                    $("#infoNote").html("");
                    $("#codeInfo").html("");
                    if (data.success == true) {
                        WeixinJSBridge.invoke('closeWindow', {}, function (res) {
                            //alert(res.err_msg);
                        });
                    } else {
                        $("#codeInfo").html("<font color='red'>" + data["content"] + "</font>");
                    }

                }

            })

        }
    }

    /*发送验证码----发送验证码*/
    var InterValObj; //timer变量，控制时间
    var count = 60; //间隔函数，1秒执行
    var curCount;//当前剩余秒数

    function sendMessage() {
        var mobile_phone = $("#mobile_phone").val();
        if (mobile_phone == "") {
            $("#infoNote").html("<font color='red'>手机号码不能为空！</font>");
        } else if (!mobile_phone.match(/^1[3|4|5|8][0-9]\d{4,8}$/)) {
            $("#infoNote").html("<font color='red'>手机号码格式不正确！请重新输入！</font>");
        } else {
            $("#btnSendCode").removeClass("green").addClass("gray");
            curCount = count;
            //设置button效果，开始计时
            $("#btnSendCode").attr("disabled", "true");
            $("#btnSendCode").val(curCount + "秒");
            InterValObj = window.setInterval(SetRemainTime, 1000); //启动计时器，1秒执行一次
            //向后台发送处理数据
            $.ajax({
                url: "/weixin_patient/login_send_message",
                type: 'post',
                data: {
                    mobile_phone: mobile_phone,
                    open_id: "<%= @open_id %>"
                },
                success: function (data) {

                    $("#infoNote").html("");
                    $("#codeInfo").html("");

                },
                error:function(){

                }

            })

        }
    }

    //timer处理函数
    function SetRemainTime() {
        if (curCount == 0) {
            window.clearInterval(InterValObj);//停止计时器
            $("#btnSendCode").removeAttr("disabled");//启用按钮
            $("#btnSendCode").val("重新发送").removeClass("gray").addClass("green");
        }
        else {
            curCount--;
            $("#btnSendCode").val(+curCount + "秒").removeClass("green").addClass("gray");
        }
    }
</script>
